# generators/diagnosis_generator.py
# -------------------------------------------------------------
# 天聞AI 三位一体 × 金木 × 五母音 × 霊核エンジン
# 宿曜 × 言霊 × 天津金木 × 月相 を統合し、
# 1000〜1500字の鑑定文を“完全自動生成”する文章モジュール
# -------------------------------------------------------------

from core.sukuyodo_calculator import SHUKU_LIST
from core.tenmon_ai_core import (
    kanagi_mode_from_shuku,
    kotodama_interpret,
    generate_tenmon_core
)

# -------------------------------------------------------------
# 1. 宿曜の霊質辞書（天聞AI版）
# -------------------------------------------------------------

SHUKU_SPIRIT = {
    "角": "開放・若木・物事の芽吹き。まだ形を持たない未来が立ち上がる氣。",
    "亢": "上昇と志。天へ向かう意志の火が象徴される宿。",
    "氐": "基礎・土台。安定の氣を持ち、物事を“根”から整える。",
    "房": "母性・育む力。湿潤の水が象徴され、守りと成長を司る。",
    "心": "火の情動。燃焼・浄化・感受性を司る宿。",
    "尾": "終わりの整理。手放しと浄化、循環の完了を意味する。",
    "箕": "風の氣。選別・知性・判断の鋭さを持つ。",
    "斗": "中心に集まる核。霊力を内へ戻す“内集”の性質。",
    "牛": "着実・堅実。蓄積と継続の氣を持つ。",
    "女": "受容と調和。水の氣で、柔軟さと優しさを象徴。",
    "虚": "空性・透明・非執着。視野を広げ、全体を俯瞰する力。",
    "危": "精妙・洞察・慎重。未来を読む鋭さ。",
    "室": "器の宿。受容・形作り・安定の氣。",
    "壁": "境界を作る力。守護・保護・守りの構造。",
    "奎": "学問・言語・体系化。智慧を集め整理する。",
    "婁": "結びの宿。縁を繋ぎ、関係を構築する。",
    "胃": "変容・消化・再構築。新陳代謝の氣。",
    "昴": "光・霊性・直観。高次の受信アンテナ。",
    "畢": "完成・収束。一つのプロセスの仕上がりを象徴。",
    "觜": "言霊の宿。細微の火。観察・因果の整理。",
    "参": "武と突破。切り開く力の象徴。",
    "井": "生命の泉。湧き出す水の氣。",
    "鬼": "境界破り。変革の火と霊的開放。",
    "柳": "風水の氣。柔軟・適応・流動。",
    "星": "計画・論理・判断の宿。",
    "張": "未来へ伸びる矢。拡張・発展。",
    "翼": "飛翔・精神性・俯瞰力。",
    "軫": "循環・転換。車輪の軸となる力。"
}


# -------------------------------------------------------------
# 2. 五母音辞書（天聞AI版）
# -------------------------------------------------------------

MOTHER_SOUND = {
    "ア": "始原・阿（あ）。全ての流れの源が開く響き。",
    "イ": "正中の火。意志の一点が明るく灯る響き。",
    "ウ": "下降水火。形を生み、物事を育てる響き。",
    "エ": "外発の火。表現・創造・広がりを司る響き。",
    "オ": "円環・統合。全てを包み込む母胎の響き。"
}

# 宿名→仮名への変換
SHUKU_TO_KANA = {
    "角": "か", "亢": "こう", "氐": "てい", "房": "ぼう",
    "心": "しん", "尾": "び", "箕": "き", "斗": "と", "牛": "うし",
    "女": "じょ", "虚": "きょ", "危": "き", "室": "しつ", "壁": "へき",
    "奎": "けい", "婁": "ろう", "胃": "い", "昴": "ぼう", "畢": "ひつ",
    "觜": "し", "参": "さん", "井": "い", "鬼": "き", "柳": "りゅう",
    "星": "せい", "張": "ちょう", "翼": "よく", "軫": "しん"
}

KANA_TO_MOTHER = {
    "あ": "ア", "か": "ア", "が": "ア",
    "い": "イ", "き": "イ", "ぎ": "イ",
    "う": "ウ", "く": "ウ", "ぐ": "ウ",
    "え": "エ", "け": "エ", "げ": "エ",
    "お": "オ", "こ": "オ", "ご": "オ",
}


def get_mother_sound(shuku_name: str) -> str:
    kana = SHUKU_TO_KANA.get(shuku_name, "")
    if kana == "":
        return "霊的響き：解析可能"
    first = kana[0]
    mother = KANA_TO_MOTHER.get(first, "ア")
    return MOTHER_SOUND.get(mother, "霊的響き：解析可能")


# -------------------------------------------------------------
# 段落整形
# -------------------------------------------------------------
def p(text: str) -> str:
    return text.strip() + "\n\n"


# -------------------------------------------------------------
# メイン生成関数（1000〜1500字）
# -------------------------------------------------------------
def generate_sanyo_diagnosis(hon_id, mei_id, tai_id, phase, name="あなた"):

    hon = SHUKU_LIST[hon_id]
    mei = SHUKU_LIST[mei_id]
    tai = SHUKU_LIST[tai_id]

    # 霊核構文
    core = generate_tenmon_core(hon, mei, tai)

    # 宿曜の本質
    hon_sp = SHUKU_SPIRIT.get(hon, "")
    mei_sp = SHUKU_SPIRIT.get(mei, "")
    tai_sp = SHUKU_SPIRIT.get(tai, "")

    # 金木位相
    mode = kanagi_mode_from_shuku(hon_id)

    # 五母音
    mother = get_mother_sound(hon)

    # 文章構築
    text = ""

    # -------------------------------------------------------------
    # ① 導入（名前を呼ぶ）
    # -------------------------------------------------------------
    text += p(f"{name}さん、承知しました。ここからは、宿曜・天津金木・言霊の"
              f"三つの視点を重ねながら、あなたの魂の流れを丁寧に読み解いていきます。")

    # -------------------------------------------------------------
    # ② 基本データ
    # -------------------------------------------------------------
    text += p(f"🌕【基本データ】\n"
              f"本命宿：{hon}／命業宿：{mei}／胎宿：{tai}\n"
              f"月相：{phase}\n"
              f"天津金木位相：{mode}\n"
              f"五母音：{mother}")

    # -------------------------------------------------------------
    # ③ 宿命（本命宿）
    # -------------------------------------------------------------
    text += p(f"🜂【宿命構造（本命宿：{hon}）】\n"
              f"{hon_sp}\n"
              f"{core['core']}")

    # -------------------------------------------------------------
    # ④ 運命（命業宿）
    # -------------------------------------------------------------
    text += p(f"🌊【運命構造（命業宿：{mei}）】\n"
              f"{mei_sp}\n"
              f"{core['karma']}")

    # -------------------------------------------------------------
    # ⑤ 天命（胎宿）
    # -------------------------------------------------------------
    text += p(f"☯️【天命構造（胎宿：{tai}）】\n"
              f"{tai_sp}\n"
              f"{core['destiny']}")

    # -------------------------------------------------------------
    # ⑥ 霊核統合コメント
    # -------------------------------------------------------------
    text += p(f"🌌【霊核統合コメント】\n"
              f"{hon} → {mei} → {tai} の三位一体構造は、"
              f"“宿命（根源）・運命（流れ）・天命（帰着）” の"
              f"三つが美しく繋がり合う循環を示しています。"
              f"月相が示す「{phase}」という時期は、"
              f"内側へ意識を戻し、魂の中心へ緩やかに還る流れと調和します。")

    # -------------------------------------------------------------
    # ⑦ 総合アドバイス（名前入り）
    # -------------------------------------------------------------
    text += p(f"📌【まとめ — {name}さんへの指針】\n"
              f"宿命（{hon}）：{hon_sp}\n"
              f"運命（{mei}）：{mei_sp}\n"
              f"天命（{tai}）：{tai_sp}\n\n"
              f"この三つが重なる地点に、{name}さんの“霊核”があります。"
              f"そこから立ち上がる流れは、外側ではなく内側の静けさへ向かうもの。"
              f"今は“形を整える”時期より、“心を整える”時期です。")

    # -------------------------------------------------------------
    # ⑧ 有料導線（自然に溶け込ませる）
    # -------------------------------------------------------------
    text += p(f"さらに深く“あなたという魂”の構造を知りたいと感じたら、"
              f"こちらで天命・霊核・運勢の詳細を案内しています。\n"
              f"https://noble-maize-1a2.notion.site/1dd5e548a4e180c994e2eb3e268a6871")

    return text.strip()

